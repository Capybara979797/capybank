<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CapyBank – Admin</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="common-auth.js"></script>
  <script>
    const CRUD_BASE         = 'https://crudcrud.com/api/eacb5cdf85cf432c8154456de0c670d5/cereri';
    const LOGS_CERERI_BASE  = 'https://crudcrud.com/api/eacb5cdf85cf432c8154456de0c670d5/logsCereri';
  </script>
</head>
<body>
  <script>
    const cu = getUser();
    if (!cu || cu.role !== 'admin') location.replace('index.html');
    capyChan.onmessage = e => {
      if (e.data.type === 'update-cereri') location.reload();
    };
  </script>

  <header class="navbar">
    <a href="index.html" class="logo">CapyBank Admin</a>
    <ul class="nav-links">
      <li><a href="admin.html" class="active">Admin</a></li>
      <li><a href="logs.html">Logs</a></li>
    </ul>
    <div class="nav-actions">
      Salut, <strong id="adminName"></strong>
      <button onclick="logout()" class="btn-secondary">Logout</button>
    </div>
    <div class="burger"
         onclick="this.classList.toggle('toggle'); document.querySelector('.nav-links').classList.toggle('nav-active');">
      <span></span><span></span><span></span>
    </div>
  </header>
  <script>
    document.getElementById('adminName').textContent = cu.username;
  </script>

  <main class="admin-wrapper">
    <h1 class="admin-title">Gestionează cererile</h1>
    <div id="summary" class="section-bg" style="max-width:800px; margin-bottom:2rem;"></div>
    <div id="requests-container"></div>
  </main>

  <footer class="footer"><p>&copy; 2025 CapyBank</p></footer>

  <script>
    (async function() {
      try {
        // 1) Preluăm cererile principale
        const resp = await fetch(CRUD_BASE);
        if (!resp.ok) throw new Error(`Fetch error: ${resp.status}`);
        const cereri = await resp.json();

        // 2) Sumar
        const counts = { Pending:0, Accepted:0, Refused:0 };
        cereri.forEach(c => counts[c.status]++);
        document.getElementById('summary').innerHTML = `
          <h3>Sumar cereri</h3>
          <p>Pending:  <strong>${counts.Pending}</strong></p>
          <p>Accepted: <strong>${counts.Accepted}</strong></p>
          <p>Refused:  <strong>${counts.Refused}</strong></p>
        `;

        // 3) Afișăm cardurile
        const container = document.getElementById('requests-container');
        if (!cereri.length) {
          container.innerHTML = '<p style="text-align:center;color:#666;">Nu sunt cereri.</p>';
        } else {
          cereri.forEach((c, idx) => {
            const clr = c.status==='Accepted'? '#2a9d8f' : c.status==='Refused'? '#e63946' : '#555';
            const card = document.createElement('div');
            card.className = 'form-card request';
            card.innerHTML = `
              <h2>Cerere #${idx+1}</h2>
              <p><strong>Data cererii:</strong> ${c.createdAt}</p>
              <p><strong>Nume:</strong> ${c.nume}</p>
              <p><strong>Email:</strong> ${c.email}</p>
              <p><strong>Sumă:</strong> ${c.suma} RON</p>
              <p><strong>Perioadă:</strong> ${c.perioada}</p>
              <p><strong>Motiv:</strong> ${c.motiv}</p>
              <p><strong>Status:</strong> <span style="color:${clr};">${c.status}</span></p>
              ${c.decisionDate? `<p><strong>Decizie la:</strong> ${c.decisionDate}</p>` : ''}
              <div class="actions">
                ${c.status==='Pending'? `
                  <button class="submit-btn" data-act="accept" data-id="${c._id}">Acceptă</button>
                  <button class="submit-btn refuse" data-act="refuse" data-id="${c._id}">Refuză</button>
                ` : ''}
                <button class="btn-secondary" data-act="delete" data-id="${c._id}">Șterge</button>
              </div>
            `;
            container.appendChild(card);
          });
        }

        // 4) Handler butoane
        container.addEventListener('click', async e => {
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;
          const act = btn.dataset.act, id = btn.dataset.id;
          const urlMain = `${CRUD_BASE}/${id}`;

          if (act==='delete') {
            if (!confirm('Ștergi definitiv această cerere?')) return;
            // șterg doar principalul
            await fetch(urlMain, { method:'DELETE' });
          } else {
            // accept/refuse → actualizez principalul
            const doc = await (await fetch(urlMain)).json();
            doc.status = act==='accept'? 'Accepted':'Refused';
            doc.decisionDate = new Date().toLocaleString();
            const {_id, ...payload} = doc;
            await fetch(urlMain, {
              method:'PUT',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            });
            // apoi actualizez și backup-ul
            const logs = await (await fetch(LOGS_CERERI_BASE)).json();
            const rec = logs.find(r => r.id === id);
            if (rec) {
              rec.status = doc.status;
              rec.decisionDate = doc.decisionDate;
              const { _id: logId, ...logPayload } = rec;
              await fetch(`${LOGS_CERERI_BASE}/${logId}`, {
                method:'PUT',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(logPayload)
              });
            }
          }

          // 5) Broadcast + reload
          capyChan.postMessage({ type:'update-cereri' });
          location.reload();
        });

      } catch (err) {
        console.error('Admin error:', err);
        document.getElementById('requests-container').innerHTML =
          `<p style="text-align:center;color:red;">Eroare: ${err.message}</p>`;
      }
    })();
  </script>
</body>
</html>
