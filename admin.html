<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CapyBank – Admin</title>
  <!-- Stiluri principale -->
  <link rel="stylesheet" href="style.css"/>
  <!-- Script autentificare per-tab -->
  <script src="common-auth.js"></script>
  <!-- Endpoint CrudCrud -->
  <script>
    const CRUD_BASE = 'https://crudcrud.com/api/9eefcd660d40431b80122294d2c4441c/cereri';
  </script>
</head>
<body>
  <!-- Verificare permisiuni admin -->
  <script>
    const cu = getUser();
    if (!cu || cu.role !== 'admin') location.replace('index.html');
    // Refresh automat când primește update
    capyChan.onmessage = e => {
      if (e.data.type === 'update-cereri') {
        location.reload();
      }
    };
  </script>

  <!-- Navbar -->
  <header class="navbar">
    <a href="index.html" class="logo">CapyBank Admin</a>
    <ul class="nav-links">
      <li><a href="admin.html" class="active">Admin</a></li>
      <li><a href="logs.html">Logs</a></li>
    </ul>
    <div class="nav-actions">
      <span>Salut, <strong id="adminName"></strong></span>
      <button onclick="logout()" class="btn-secondary">Logout</button>
    </div>
    <div class="burger"
         onclick="this.classList.toggle('toggle'); document.querySelector('.nav-links').classList.toggle('nav-active');">
      <span></span><span></span><span></span>
    </div>
  </header>
  <script>document.getElementById('adminName').textContent = cu.username;</script>

  <!-- Conținut principal -->
  <main class="admin-wrapper">
    <h1 class="admin-title">Gestionează cererile</h1>

    <!-- Sumar cereri -->
    <div id="summary" class="section-bg" style="max-width:800px; margin-bottom:2rem;"></div>

    <!-- Container pentru cardurile cererilor -->
    <div id="requests-container"></div>
  </main>

  <!-- Footer -->
  <footer class="footer"><p>&copy; 2025 CapyBank</p></footer>

  <!-- Script principal Admin -->
  <script>
    (async function() {
      try {
        // Preluăm toate cererile de pe CrudCrud
        const response = await fetch(CRUD_BASE);
        if (!response.ok) throw new Error(`Fetch error: ${response.status}`);
        const cereri = await response.json();

        // Calculăm sumar
        const counts = { Pending:0, Accepted:0, Refused:0 };
        cereri.forEach(c => counts[c.status]++);

        document.getElementById('summary').innerHTML = `
          <h3>Sumar cereri</h3>
          <p>Pending:  <strong>${counts.Pending}</strong></p>
          <p>Accepted: <strong>${counts.Accepted}</strong></p>
          <p>Refused:  <strong>${counts.Refused}</strong></p>
        `;

        const container = document.getElementById('requests-container');
        if (!cereri.length) {
          container.innerHTML = '<p style="text-align:center;color:#666;">Nu sunt cereri.</p>';
        } else {
          cereri.forEach((c, idx) => {
            const color = c.status === 'Accepted' ? '#2a9d8f'
                        : c.status === 'Refused'  ? '#e63946' : '#555';
            const card = document.createElement('div');
            card.className = 'form-card request';
            card.innerHTML = `
              <h2>Cerere #${idx+1}</h2>
              <p><strong>Data cererii:</strong> ${c.createdAt}</p>
              <p><strong>Nume:</strong> ${c.nume}</p>
              <p><strong>Email:</strong> ${c.email}</p>
              <p><strong>Sumă:</strong> ${c.suma} RON</p>
              <p><strong>Perioadă:</strong> ${c.perioada}</p>
              <p><strong>Motiv:</strong> ${c.motiv}</p>
              <p><strong>Status:</strong> <span style="color:${color}">${c.status}</span></p>
              ${c.decisionDate ? `<p><strong>Decizie la:</strong> ${c.decisionDate}</p>` : ''}
              <div class="actions">
                ${c.status === 'Pending' ? `
                  <button class="submit-btn" data-act="accept" data-id="${c._id}">Acceptă</button>
                  <button class="submit-btn refuse" data-act="refuse" data-id="${c._id}">Refuză</button>
                ` : ''}
                <button class="btn-secondary" data-act="delete" data-id="${c._id}">Șterge</button>
              </div>
            `;
            container.appendChild(card);
          });
        }

        // Handler general pentru accept, refuse, delete
        container.addEventListener('click', async event => {
          const btn = event.target.closest('button[data-act]');
          if (!btn) return;
          const act = btn.dataset.act;
          const id  = btn.dataset.id;
          const url = `${CRUD_BASE}/${id}`;

          if (act === 'delete') {
            if (!confirm('Ștergi definitiv această cerere?')) return;
            await fetch(url, { method:'DELETE' });
          } else {
            // Preluăm și actualizăm documentul
            const docRes = await fetch(url);
            const doc    = await docRes.json();
            doc.status       = act === 'accept' ? 'Accepted' : 'Refused';
            doc.decisionDate = new Date().toLocaleString();
            // Eliminăm _id din payload
            const { _id, ...payload } = doc;
            await fetch(url, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
          }

          // Reload imediat pentru admin
          location.reload();
          // Notificăm celelalte tab-uri
          capyChan.postMessage({ type:'update-cereri' });
        });

      } catch (err) {
        console.error('Admin error:', err);
        document.getElementById('requests-container').innerHTML =
          `<p style="text-align:center;color:red;">Eroare: ${err.message}</p>`;
      }
    })();
  </script>
</body>
</html>
